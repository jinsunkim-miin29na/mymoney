<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë¶€ë¶€ í†µí•© ìì‚°ê´€ë¦¬ v8.3 (ëˆ„ì ìì‚°)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Apple SD Gothic Neo', sans-serif; padding-bottom: 80px; background-color: #f3f4f6; }
        
        a, a:visited, a:hover, a:active { color: inherit; text-decoration: none; }

        .excel-input { width: 100%; height: 100%; padding: 0 8px; border: none; outline: none; background: transparent; }
        .excel-input:focus { background-color: #eff6ff; }
        .mini-table th { font-size: 0.75rem; padding: 8px 4px; text-align: left; color: #6b7280; background: #f9fafb; }
        .mini-table td { font-size: 0.9rem; padding: 10px 4px; border-bottom: 1px solid #f3f4f6; }
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }
        .badge-card { background: #f3f4f6; color: #4b5563; border: 1px solid #d1d5db; }
        .badge-cash { background: #fff7ed; color: #c2410c; border: 1px solid #fed7aa; }
        .hidden-tab { display: none; }
        
        .summary-card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 16px; overflow: hidden; }
        .summary-header { padding: 12px 16px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        
        .force-purple { background-color: #6b21a8 !important; color: white !important; }
    </style>
</head>
<body>

    <div id="view-write">
        <div class="bg-white sticky top-0 z-40 shadow-md border-b">
            <div class="flex justify-between items-center p-3 bg-gray-800 text-white">
                <h1 class="font-bold text-lg">ğŸ“ ì›”ë§ ì •ì‚°</h1>
                <input type="month" id="global-month" class="text-gray-900 font-bold px-2 py-1 rounded border-none outline-none">
            </div>
            
            <div class="flex flex-col md:flex-row bg-white">
                <div class="flex h-12 border-b md:border-b-0 md:border-r border-gray-200">
                    <select id="in-who" class="excel-input w-20 border-r text-center font-bold bg-gray-50 text-gray-700">
                        <option value="husband">ë‚¨í¸</option>
                        <option value="wife">ì•„ë‚´</option>
                    </select>
                    <select id="in-type" class="excel-input w-20 border-r text-center font-bold bg-gray-50 text-gray-700" onchange="window.updateForm()">
                        <option value="income">ìˆ˜ì…</option>
                        <option value="expense">ì§€ì¶œ</option>
                    </select>
                    <select id="in-method" class="hidden excel-input w-24 border-r text-center text-sm bg-white">
                        <option value="ì¹´ë“œ">ì¹´ë“œ</option>
                        <option value="í˜„ê¸ˆ">í˜„ê¸ˆ/ì´ì²´</option>
                    </select>
                </div>
                <div class="flex h-12 flex-1 items-center">
                    <select id="in-category" class="excel-input w-28 border-r text-sm font-bold text-gray-600" onchange="window.updateHint()">
                    </select>
                    <input type="text" id="in-desc" class="excel-input flex-1 min-w-[80px]" placeholder="ë‚´ìš©">
                    <input type="number" id="in-amount" class="excel-input w-24 text-right font-bold text-lg text-blue-900" placeholder="0">
                    <button id="btn-add" class="bg-blue-600 text-white w-16 h-full font-bold text-sm hover:bg-blue-700">ì…ë ¥</button>
                </div>
            </div>
        </div>

        <div class="max-w-6xl mx-auto p-3 mt-2">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 flex justify-between items-center">
                <div>
                    <p class="text-xs text-gray-500 mb-1">ì´ë‹¬ì˜ í˜„ê¸ˆ íë¦„ (í•©ì‚°)</p>
                    <p class="text-2xl font-bold text-blue-600" id="month-balance">0ì›</p>
                </div>
                <div class="text-right">
                    <p class="text-xs text-red-400 mb-1">ë§ˆí†µ/ëŒ€ì¶œ ì”ì•¡</p>
                    <p class="text-xl font-bold text-red-600">-12,500,000ì›</p>
                </div>
            </div>
        </div>

        <div class="max-w-6xl mx-auto p-3 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="space-y-4">
                <h2 class="font-bold text-lg text-gray-800 flex items-center gap-2">ğŸ‘¨â€ğŸ’» ë‚¨í¸</h2>
                <div class="bg-white rounded shadow-sm border-t-4 border-blue-500">
                    <div class="px-3 py-2 bg-blue-50 flex justify-between"><span class="text-sm font-bold">ìˆ˜ì…</span><span id="total-husband-income" class="text-sm font-bold">0ì›</span></div>
                    <table class="w-full mini-table"><tbody id="list-husband-income"></tbody></table>
                </div>
                <div class="bg-white rounded shadow-sm border-t-4 border-red-500">
                    <div class="px-3 py-2 bg-red-50 flex justify-between"><span class="text-sm font-bold">ì§€ì¶œ</span><span id="total-husband-expense" class="text-sm font-bold">0ì›</span></div>
                    <table class="w-full mini-table"><tbody id="list-husband-expense"></tbody></table>
                </div>
            </div>
            <div class="space-y-4">
                <h2 class="font-bold text-lg text-gray-800 flex items-center gap-2">ğŸ‘©â€ğŸ’¼ ì•„ë‚´</h2>
                <div class="bg-white rounded shadow-sm border-t-4 border-indigo-500">
                    <div class="px-3 py-2 bg-indigo-50 flex justify-between"><span class="text-sm font-bold">ìˆ˜ì…</span><span id="total-wife-income" class="text-sm font-bold">0ì›</span></div>
                    <table class="w-full mini-table"><tbody id="list-wife-income"></tbody></table>
                </div>
                <div class="bg-white rounded shadow-sm border-t-4 border-pink-500">
                    <div class="px-3 py-2 bg-pink-50 flex justify-between"><span class="text-sm font-bold">ì§€ì¶œ</span><span id="total-wife-expense" class="text-sm font-bold">0ì›</span></div>
                    <table class="w-full mini-table"><tbody id="list-wife-expense"></tbody></table>
                </div>
            </div>
        </div>
    </div>

    <div id="view-summary" class="hidden-tab">
        <div class="sticky top-0 z-40 shadow-md p-4 flex justify-between items-center force-purple">
            <h1 class="font-bold text-lg">ğŸ“Š ì›”ë³„/ì¸ë¬¼ë³„ ìš”ì•½</h1>
            <div class="text-xs text-purple-200">v8.3 (ëˆ„ì ìì‚°)</div>
        </div>

        <div class="max-w-4xl mx-auto p-4" id="summary-container">
            </div>

        <div class="p-4 mb-20">
            <div class="bg-gray-800 text-white rounded-xl p-5 shadow-lg w-full mx-auto max-w-md">
                <h3 class="text-center text-sm text-gray-400 mb-4 border-b border-gray-600 pb-2">ğŸ’° ìµœì¢… ëˆ„ì  ìì‚° (í˜„ì¬ ê¸°ì¤€)</h3>
                
                <div class="flex justify-between items-center mb-3">
                    <span class="text-blue-300 font-bold flex items-center gap-2">ğŸ‘¨â€ğŸ’» ë‚¨í¸ ì´ ìì‚°</span>
                    <span class="text-xl font-bold" id="grand-husband-balance">0ì›</span>
                </div>
                
                <div class="flex justify-between items-center">
                    <span class="text-pink-300 font-bold flex items-center gap-2">ğŸ‘©â€ğŸ’¼ ì•„ë‚´ ì´ ìì‚°</span>
                    <span class="text-xl font-bold" id="grand-wife-balance">0ì›</span>
                </div>
            </div>
        </div>
    </div>

    <nav class="fixed bottom-0 w-full bg-white border-t border-gray-300 flex justify-around items-center h-16 z-50 shadow-lg">
        <button onclick="window.switchTab('write')" class="flex flex-col items-center w-full h-full justify-center active-tab text-blue-600" id="nav-write">
            <span class="text-2xl">ğŸ“</span>
            <span class="text-xs font-bold mt-1">ì‘ì„±í•˜ê¸°</span>
        </button>
        <div class="w-px h-8 bg-gray-200"></div>
        <button onclick="window.switchTab('summary')" class="flex flex-col items-center w-full h-full justify-center text-gray-400" id="nav-summary">
            <span class="text-2xl">ğŸ“Š</span>
            <span class="text-xs font-bold mt-1">ì „ì²´ë³´ê¸°</span>
        </button>
    </nav>

    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyBAGmA7oUu5xZcqiEn_JIZ21CO0n6bRFUM",
            authDomain: "mymoney-ledger.firebaseapp.com",
            projectId: "mymoney-ledger",
            storageBucket: "mymoney-ledger.firebasestorage.app",
            messagingSenderId: "536040673268",
            appId: "1:536040673268:web:5cc54395dd33fbb99bb3a1"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let ledgerData = [];
        const globalMonthEl = document.getElementById('global-month');
        const today = new Date();
        globalMonthEl.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;

        const CAT_INCOME = ["ì›”ê¸‰", "ê³„ì•½ê¸ˆ", "ì •ë¶€ì§€ì›ê¸ˆ", "ê²½ì¡°ì‚¬ë¹„", "ê¸°íƒ€ìˆ˜ì…"];
        const CAT_EXPENSE = ["ì›” ì¹´ë“œê°’", "ê³ ì •ë¹„", "ìƒí™œë¹„", "ê¸°íƒ€ì§€ì¶œ"];

        const renderDaily = () => {
            const targetMonth = globalMonthEl.value;
            const currentData = ledgerData.filter(d => d.month === targetMonth);
            
            ['husband', 'wife'].forEach(w => ['income', 'expense'].forEach(t => {
                document.getElementById(`list-${w}-${t}`).innerHTML = '';
                document.getElementById(`total-${w}-${t}`).innerText = '0ì›';
            }));

            let totalIncome = 0, totalExpense = 0;

            currentData.forEach(item => {
                const tbody = document.getElementById(`list-${item.who}-${item.type}`);
                if (!tbody) return; 

                let badge = "";
                if(item.type === 'expense') {
                    const bClass = item.method === 'ì¹´ë“œ' ? 'badge-card' : 'badge-cash';
                    badge = `<span class="badge ${bClass} mr-1">${item.method}</span>`;
                }
                
                tbody.innerHTML += `
                    <tr>
                        <td>
                            <div class="text-xs text-gray-500">[${item.cat}]</div>
                            <div class="font-bold text-gray-700">${badge}${item.desc}</div>
                        </td>
                        <td class="text-right font-bold ${item.type==='income'?'text-blue-600':'text-red-600'}">
                            ${item.amount.toLocaleString()}
                        </td>
                        <td class="w-8 text-center"><button onclick="window.removeData('${item.dbId}')" class="text-gray-300 hover:text-red-500">Ã—</button></td>
                    </tr>
                `;
                if(item.type === 'income') totalIncome += item.amount;
                else totalExpense += item.amount;
            });

            ['husband', 'wife'].forEach(w => ['income', 'expense'].forEach(t => {
                const sum = currentData.filter(d => d.who === w && d.type === t).reduce((a,c)=>a+c.amount,0);
                document.getElementById(`total-${w}-${t}`).innerText = sum.toLocaleString() + 'ì›';
            }));

            document.getElementById('month-balance').innerText = (totalIncome - totalExpense).toLocaleString() + 'ì›';
        }

        // [í•µì‹¬ ë³€ê²½] ëˆ„ì  ìì‚°ì„ ê³„ì‚°í•˜ëŠ” ë¡œì§ìœ¼ë¡œ ë³€ê²½
        const renderSummary = () => {
            try {
                const container = document.getElementById('summary-container');
                container.innerHTML = '';

                const summary = {};
                
                // 1. ì›”ë³„ ë°ì´í„° ì§‘ê³„
                ledgerData.forEach(item => {
                    if(!item.who || !item.month || !item.type) return;

                    if(!summary[item.month]) {
                        summary[item.month] = { 
                            husband: { income: 0, expense: 0 },
                            wife: { income: 0, expense: 0 }
                        };
                    }
                    if(summary[item.month][item.who]) {
                        if(item.type === 'income') summary[item.month][item.who].income += (item.amount || 0);
                        else summary[item.month][item.who].expense += (item.amount || 0);
                    }
                });

                // 2. ê³¼ê±° -> ìµœì‹  ìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ëˆ„ì  ê³„ì‚°
                const sortedMonthsAsc = Object.keys(summary).sort();
                
                let accHusband = 0;
                let accWife = 0;

                // ê° ë‹¬ë§ˆë‹¤ ëˆ„ì ì•¡ ê³„ì‚°í•˜ì—¬ ì €ì¥
                sortedMonthsAsc.forEach(month => {
                    const s = summary[month];
                    // ì´ë²ˆ ë‹¬ ìˆœì´ìµ
                    const netHusband = s.husband.income - s.husband.expense;
                    const netWife = s.wife.income - s.wife.expense;
                    
                    // ëˆ„ì ì•¡ ê°±ì‹ 
                    accHusband += netHusband;
                    accWife += netWife;

                    // í•´ë‹¹ ì›”ì˜ ë°ì´í„°ì— 'ëˆ„ì ìì‚°' ì†ì„± ì¶”ê°€
                    s.husband.totalAsset = accHusband;
                    s.wife.totalAsset = accWife;
                });

                // 3. í™”ë©´ì—ëŠ” ìµœì‹ ìˆœ(ì—­ìˆœ)ìœ¼ë¡œ ë³´ì—¬ì¤Œ
                const sortedMonthsDesc = sortedMonthsAsc.reverse();

                sortedMonthsDesc.forEach(month => {
                    const s = summary[month];
                    const monthNet = (s.husband.income - s.husband.expense) + (s.wife.income - s.wife.expense);
                    
                    const cardHTML = `
                        <div class="summary-card">
                            <div class="summary-header force-purple">
                                <span>ğŸ“… ${month}</span>
                                <span class="text-xs font-normal opacity-80">ì›” ìˆœìˆ˜ìµ: ${monthNet > 0 ? '+' : ''}${monthNet.toLocaleString()}</span>
                            </div>
                            
                            <div class="p-3 border-b border-gray-100" style="background-color: #eff6ff;">
                                <div class="font-bold text-blue-800 mb-2 flex items-center gap-1">ğŸ‘¨â€ğŸ’» ë‚¨í¸</div>
                                <div class="grid grid-cols-3 gap-1 text-center items-center">
                                    <div class="text-blue-600">
                                        <div class="text-xs text-gray-500 mb-1">ìˆ˜ì…</div>
                                        <div class="font-bold text-sm">${s.husband.income.toLocaleString()}</div>
                                    </div>
                                    <div class="text-red-500 border-l border-r border-blue-100">
                                        <div class="text-xs text-gray-500 mb-1">ì§€ì¶œ</div>
                                        <div class="font-bold text-sm">${s.husband.expense.toLocaleString()}</div>
                                    </div>
                                    <div class="text-gray-800">
                                        <div class="text-xs text-blue-900 font-bold mb-1">í˜„ ìì‚°(ëˆ„ì )</div>
                                        <div class="font-bold text-base text-blue-900">${s.husband.totalAsset.toLocaleString()}</div>
                                    </div>
                                </div>
                            </div>

                            <div class="p-3" style="background-color: #fdf2f8;">
                                <div class="font-bold text-pink-800 mb-2 flex items-center gap-1">ğŸ‘©â€ğŸ’¼ ì•„ë‚´</div>
                                <div class="grid grid-cols-3 gap-1 text-center items-center">
                                    <div class="text-blue-600">
                                        <div class="text-xs text-gray-500 mb-1">ìˆ˜ì…</div>
                                        <div class="font-bold text-sm">${s.wife.income.toLocaleString()}</div>
                                    </div>
                                    <div class="text-red-500 border-l border-r border-pink-100">
                                        <div class="text-xs text-gray-500 mb-1">ì§€ì¶œ</div>
                                        <div class="font-bold text-sm">${s.wife.expense.toLocaleString()}</div>
                                    </div>
                                    <div class="text-gray-800">
                                        <div class="text-xs text-pink-900 font-bold mb-1">í˜„ ìì‚°(ëˆ„ì )</div>
                                        <div class="font-bold text-base text-pink-900">${s.wife.totalAsset.toLocaleString()}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    container.innerHTML += cardHTML;
                });

                document.getElementById('grand-husband-balance').innerText = accHusband.toLocaleString() + 'ì›';
                document.getElementById('grand-wife-balance').innerText = accWife.toLocaleString() + 'ì›';

            } catch (err) {
                console.error(err);
                document.getElementById('summary-container').innerHTML = `<div class="p-4 text-red-500">ì—ëŸ¬ ë°œìƒ: ${err.message}</div>`;
            }
        }

        const switchTab = (mode) => {
            const btnWrite = document.getElementById('nav-write');
            const btnSummary = document.getElementById('nav-summary');
            
            if (mode === 'write') {
                document.getElementById('view-write').classList.remove('hidden-tab');
                document.getElementById('view-summary').classList.add('hidden-tab');
                
                btnWrite.classList.add('text-blue-600', 'active-tab'); 
                btnWrite.classList.remove('text-gray-400');
                btnSummary.classList.add('text-gray-400'); 
                btnSummary.classList.remove('text-blue-600', 'active-tab');
                
                renderDaily();
            } else {
                document.getElementById('view-write').classList.add('hidden-tab');
                document.getElementById('view-summary').classList.remove('hidden-tab');
                
                btnSummary.classList.add('text-blue-600', 'active-tab'); 
                btnSummary.classList.remove('text-gray-400');
                btnWrite.classList.add('text-gray-400'); 
                btnWrite.classList.remove('text-blue-600', 'active-tab');
                
                renderSummary();
            }
        }

        const updateForm = () => {
            const type = document.getElementById('in-type').value;
            const methodSelect = document.getElementById('in-method');
            const catSelect = document.getElementById('in-category');
            catSelect.innerHTML = ''; 
            if(type === 'income') {
                methodSelect.classList.add('hidden');
                CAT_INCOME.forEach(c => catSelect.innerHTML += `<option value="${c}">${c}</option>`);
            } else {
                methodSelect.classList.remove('hidden');
                CAT_EXPENSE.forEach(c => catSelect.innerHTML += `<option value="${c}">${c}</option>`);
            }
            updateHint();
        }

        const updateHint = () => {
            const cat = document.getElementById('in-category').value;
            const desc = document.getElementById('in-desc');
            if(cat === 'ì›” ì¹´ë“œê°’') desc.placeholder = "ì˜ˆ: í˜„ëŒ€ì¹´ë“œ";
            else if(cat === 'ê³ ì •ë¹„') desc.placeholder = "ì˜ˆ: ì›”ì„¸";
            else desc.placeholder = "ë‚´ìš© ì…ë ¥";
        }

        const addData = async () => {
            const month = document.getElementById('global-month').value;
            const who = document.getElementById('in-who').value;
            const type = document.getElementById('in-type').value;
            const cat = document.getElementById('in-category').value;
            const method = type === 'expense' ? document.getElementById('in-method').value : '';
            const desc = document.getElementById('in-desc').value;
            const amount = Number(document.getElementById('in-amount').value);

            if(!desc || amount === 0) return alert("ë‚´ìš©/ê¸ˆì•¡ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");

            try {
                await addDoc(collection(db, "ledger"), {
                    id: Date.now(), month, who, type, cat, method, desc, amount
                });
                document.getElementById('in-desc').value = '';
                document.getElementById('in-amount').value = '';
                document.getElementById('in-desc').focus();
            } catch (e) {
                alert("ì €ì¥ ì˜¤ë¥˜: " + e.message);
            }
        }

        const removeData = async (dbId) => {
            if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                await deleteDoc(doc(db, "ledger", dbId));
            }
        }

        window.switchTab = switchTab;
        window.updateForm = updateForm;
        window.updateHint = updateHint;
        window.addData = addData;
        window.removeData = removeData;
        window.renderDaily = renderDaily;
        window.renderSummary = renderSummary;

        const q = query(collection(db, "ledger"), orderBy("id", "desc"));
        onSnapshot(q, (snapshot) => {
            ledgerData = [];
            snapshot.forEach((doc) => {
                const data = doc.data();
                if(data.who && data.type && data.month) {
                    ledgerData.push({ dbId: doc.id, ...data });
                }
            });
            const isSummaryTab = !document.getElementById('view-summary').classList.contains('hidden-tab');
            if(isSummaryTab) renderSummary();
            else renderDaily();
        });

        updateForm();
        globalMonthEl.addEventListener('change', renderDaily);
        document.getElementById('in-amount').addEventListener('keydown', (e) => {
            if(e.key === 'Enter') addData();
        });
        document.getElementById('btn-add').addEventListener('click', addData);

    </script>
</body>
</html>
