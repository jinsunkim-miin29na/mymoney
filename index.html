<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìš°ë¦¬ì§‘ ê°€ê³„ë¶€ (DBì—°ë™í˜•)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Apple SD Gothic Neo', sans-serif; padding-bottom: 80px; }
        .excel-input { width: 100%; height: 100%; padding: 0 8px; border: none; outline: none; background: transparent; }
        .excel-input:focus { background-color: #eff6ff; }
        .mini-table th { font-size: 0.75rem; padding: 8px 4px; text-align: left; color: #6b7280; background: #f9fafb; }
        .mini-table td { font-size: 0.9rem; padding: 10px 4px; border-bottom: 1px solid #f3f4f6; }
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }
        .badge-card { background: #f3f4f6; color: #4b5563; border: 1px solid #d1d5db; }
        .badge-cash { background: #fff7ed; color: #c2410c; border: 1px solid #fed7aa; }
        .hidden-tab { display: none; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="view-write">
        <div class="bg-white sticky top-0 z-40 shadow-md border-b">
            <div class="flex justify-between items-center p-3 bg-gray-800 text-white">
                <h1 class="font-bold text-lg">ğŸ“ ì›”ë§ ì •ì‚° (DBì—°ë™)</h1>
                <input type="month" id="global-month" class="text-gray-900 font-bold px-2 py-1 rounded border-none outline-none">
            </div>
            
            <div class="flex flex-col md:flex-row bg-white">
                <div class="flex h-12 border-b md:border-b-0 md:border-r border-gray-200">
                    <select id="in-who" class="excel-input w-20 border-r text-center font-bold bg-gray-50 text-gray-700">
                        <option value="husband">ë‚¨í¸</option>
                        <option value="wife">ì•„ë‚´</option>
                    </select>
                    <select id="in-type" class="excel-input w-20 border-r text-center font-bold bg-gray-50 text-gray-700" onchange="window.updateForm()">
                        <option value="income">ìˆ˜ì…</option>
                        <option value="expense">ì§€ì¶œ</option>
                    </select>
                    <select id="in-method" class="hidden excel-input w-24 border-r text-center text-sm bg-white">
                        <option value="ì¹´ë“œ">ì¹´ë“œ</option>
                        <option value="í˜„ê¸ˆ">í˜„ê¸ˆ/ì´ì²´</option>
                    </select>
                </div>
                <div class="flex h-12 flex-1 items-center">
                    <select id="in-category" class="excel-input w-28 border-r text-sm font-bold text-gray-600" onchange="window.updateHint()">
                        </select>
                    <input type="text" id="in-desc" class="excel-input flex-1 min-w-[80px]" placeholder="ë‚´ìš©">
                    <input type="number" id="in-amount" class="excel-input w-24 text-right font-bold text-lg text-blue-900" placeholder="0">
                    <button id="btn-add" class="bg-blue-600 text-white w-16 h-full font-bold text-sm hover:bg-blue-700">ì…ë ¥</button>
                </div>
            </div>
        </div>

        <div class="max-w-6xl mx-auto p-3 mt-2">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 flex justify-between items-center">
                <div>
                    <p class="text-xs text-gray-500 mb-1">ì´ë‹¬ì˜ í˜„ê¸ˆ ì”ì•¡</p>
                    <p class="text-2xl font-bold text-blue-600" id="month-balance">0ì›</p>
                </div>
                <div class="text-right">
                    <p class="text-xs text-red-400 mb-1">ë§ˆí†µ/ëŒ€ì¶œ ì”ì•¡</p>
                    <p class="text-xl font-bold text-red-600">-12,500,000ì›</p>
                </div>
            </div>
        </div>

        <div class="max-w-6xl mx-auto p-3 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="space-y-4">
                <h2 class="font-bold text-lg text-gray-800 flex items-center gap-2">ğŸ‘¨â€ğŸ’» ë‚¨í¸</h2>
                <div class="bg-white rounded shadow-sm border-t-4 border-blue-500">
                    <div class="px-3 py-2 bg-blue-50 flex justify-between"><span class="text-sm font-bold">ìˆ˜ì…</span><span id="total-husband-income" class="text-sm font-bold">0ì›</span></div>
                    <table class="w-full mini-table"><tbody id="list-husband-income"></tbody></table>
                </div>
                <div class="bg-white rounded shadow-sm border-t-4 border-red-500">
                    <div class="px-3 py-2 bg-red-50 flex justify-between"><span class="text-sm font-bold">ì§€ì¶œ</span><span id="total-husband-expense" class="text-sm font-bold">0ì›</span></div>
                    <table class="w-full mini-table"><tbody id="list-husband-expense"></tbody></table>
                </div>
            </div>
            <div class="space-y-4">
                <h2 class="font-bold text-lg text-gray-800 flex items-center gap-2">ğŸ‘©â€ğŸ’¼ ì•„ë‚´</h2>
                <div class="bg-white rounded shadow-sm border-t-4 border-indigo-500">
                    <div class="px-3 py-2 bg-indigo-50 flex justify-between"><span class="text-sm font-bold">ìˆ˜ì…</span><span id="total-wife-income" class="text-sm font-bold">0ì›</span></div>
                    <table class="w-full mini-table"><tbody id="list-wife-income"></tbody></table>
                </div>
                <div class="bg-white rounded shadow-sm border-t-4 border-pink-500">
                    <div class="px-3 py-2 bg-pink-50 flex justify-between"><span class="text-sm font-bold">ì§€ì¶œ</span><span id="total-wife-expense" class="text-sm font-bold">0ì›</span></div>
                    <table class="w-full mini-table"><tbody id="list-wife-expense"></tbody></table>
                </div>
            </div>
        </div>
    </div>

    <div id="view-summary" class="hidden-tab">
        <div class="bg-white sticky top-0 z-40 shadow-md p-4 bg-gray-800 text-white">
            <h1 class="font-bold text-lg">ğŸ“Š ì „ì²´ ê¸°ê°„ ìš”ì•½</h1>
        </div>
        <div class="max-w-4xl mx-auto p-4">
            <div class="bg-white rounded-lg shadow overflow-hidden">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-100 text-gray-700 uppercase">
                        <tr>
                            <th class="px-4 py-3">ì›”(Month)</th>
                            <th class="px-4 py-3 text-right text-blue-600">ì´ ìˆ˜ì…</th>
                            <th class="px-4 py-3 text-right text-red-600">ì´ ì§€ì¶œ</th>
                            <th class="px-4 py-3 text-right">ì”ì•¡</th>
                        </tr>
                    </thead>
                    <tbody id="summary-body" class="divide-y divide-gray-200"></tbody>
                </table>
            </div>
            <div class="mt-6 p-4 bg-indigo-50 rounded-lg border border-indigo-100 text-center">
                <p class="text-gray-500 text-sm mb-1">ì§€ê¸ˆê¹Œì§€ ëª¨ì€ ëˆ (ëˆ„ì  ì”ì•¡)</p>
                <p class="text-3xl font-bold text-indigo-700" id="grand-total-balance">0ì›</p>
            </div>
        </div>
    </div>

    <nav class="fixed bottom-0 w-full bg-white border-t border-gray-300 flex justify-around items-center h-16 z-50 shadow-lg">
        <button onclick="window.switchTab('write')" class="flex flex-col items-center w-full h-full justify-center active-tab text-blue-600">
            <span class="text-2xl">ğŸ“</span>
            <span class="text-xs font-bold mt-1">ì‘ì„±í•˜ê¸°</span>
        </button>
        <div class="w-px h-8 bg-gray-200"></div>
        <button onclick="window.switchTab('summary')" class="flex flex-col items-center w-full h-full justify-center text-gray-400">
            <span class="text-2xl">ğŸ“Š</span>
            <span class="text-xs font-bold mt-1">ì „ì²´ë³´ê¸°</span>
        </button>
    </nav>

    <script type="module">
        // =========================================================
        // ğŸ›‘ ì¤‘ìš”: ì•„ë˜ ê°’ì„ 1ë‹¨ê³„ì—ì„œ ë³µì‚¬í•œ ê°’ìœ¼ë¡œ ë°”ê¿”ì£¼ì„¸ìš”!
        // =========================================================
        const firebaseConfig = {
            apiKey: "AIzaSyBAGmA7oUu5xZcqiEn_JIZ21CO0n6bRFUM",
            authDomain: "mymoney-ledger.firebaseapp.com",
            projectId: "mymoney-ledger",
            storageBucket: "mymoney-ledger.firebasestorage.app",
            messagingSenderId: "536040673268",
            appId: "1:536040673268:web:5cc54395dd33fbb99bb3a1"
        };
        // =========================================================

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ë³€ìˆ˜ ë° ì„¤ì •
        let ledgerData = [];
        const today = new Date();
        const globalMonthEl = document.getElementById('global-month');
        globalMonthEl.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;

        const CAT_INCOME = ["ì›”ê¸‰", "ê³„ì•½ê¸ˆ", "ì •ë¶€ì§€ì›ê¸ˆ", "ê²½ì¡°ì‚¬ë¹„", "ê¸°íƒ€ìˆ˜ì…"];
        const CAT_EXPENSE = ["ì›” ì¹´ë“œê°’", "ê³ ì •ë¹„", "ìƒí™œë¹„", "ê¸°íƒ€ì§€ì¶œ"];

        // --- ì‹¤ì‹œê°„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (DB Listener) ---
        // DBì— ë³€í™”ê°€ ìƒê¸°ë©´(ë‚¨í¸ì´ ì…ë ¥í•˜ë©´) ì¦‰ì‹œ ì´ í•¨ìˆ˜ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤.
        const q = query(collection(db, "ledger"), orderBy("id", "desc"));
        const unsubscribe = onSnapshot(q, (snapshot) => {
            ledgerData = [];
            snapshot.forEach((doc) => {
                ledgerData.push({ dbId: doc.id, ...doc.data() });
            });
            // ë°ì´í„°ê°€ ë¡œë“œë˜ë©´ í™”ë©´ ê°±ì‹ 
            renderDaily();
            renderSummary();
        });

        // --- ê¸°ëŠ¥ êµ¬í˜„ ---
        
        // ë°ì´í„° ì¶”ê°€ (DB ì €ì¥)
        window.addData = async function() {
            const month = document.getElementById('global-month').value;
            const who = document.getElementById('in-who').value;
            const type = document.getElementById('in-type').value;
            const cat = document.getElementById('in-category').value;
            const method = type === 'expense' ? document.getElementById('in-method').value : '';
            const desc = document.getElementById('in-desc').value;
            const amount = Number(document.getElementById('in-amount').value);

            if(!desc || amount === 0) return alert("ë‚´ìš©ê³¼ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            try {
                // Firestoreì— ì €ì¥
                await addDoc(collection(db, "ledger"), {
                    id: Date.now(), // ì •ë ¬ìš© íƒ€ì„ìŠ¤íƒ¬í”„
                    month, who, type, cat, method, desc, amount
                });
                
                // ì…ë ¥ì°½ ì´ˆê¸°í™”
                document.getElementById('in-desc').value = '';
                document.getElementById('in-amount').value = '';
                document.getElementById('in-desc').focus();
            } catch (e) {
                console.error("Error adding document: ", e);
                alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }

        // ë°ì´í„° ì‚­ì œ (DB ì‚­ì œ)
        window.removeData = async function(dbId) {
            if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                await deleteDoc(doc(db, "ledger", dbId));
            }
        }

        // --- í™”ë©´ ë Œë”ë§ ë¡œì§ (UI) ---
        window.renderDaily = function() {
            const targetMonth = globalMonthEl.value;
            const currentData = ledgerData.filter(d => d.month === targetMonth);
            
            // í…Œì´ë¸” ì´ˆê¸°í™”
            ['husband', 'wife'].forEach(w => ['income', 'expense'].forEach(t => {
                document.getElementById(`list-${w}-${t}`).innerHTML = '';
                document.getElementById(`total-${w}-${t}`).innerText = '0ì›';
            }));

            let totalIncome = 0, totalExpense = 0;

            currentData.forEach(item => {
                const tbody = document.getElementById(`list-${item.who}-${item.type}`);
                let badge = "";
                if(item.type === 'expense') {
                    const bClass = item.method === 'ì¹´ë“œ' ? 'badge-card' : 'badge-cash';
                    badge = `<span class="badge ${bClass} mr-1">${item.method}</span>`;
                }
                
                tbody.innerHTML += `
                    <tr>
                        <td>
                            <div class="text-xs text-gray-500">[${item.cat}]</div>
                            <div class="font-bold text-gray-700">${badge}${item.desc}</div>
                        </td>
                        <td class="text-right font-bold ${item.type==='income'?'text-blue-600':'text-red-600'}">
                            ${item.amount.toLocaleString()}
                        </td>
                        <td class="w-8 text-center"><button onclick="window.removeData('${item.dbId}')" class="text-gray-300 hover:text-red-500">Ã—</button></td>
                    </tr>
                `;

                if(item.type === 'income') totalIncome += item.amount;
                else totalExpense += item.amount;
            });

            // í•©ê³„ ì—…ë°ì´íŠ¸
            ['husband', 'wife'].forEach(w => ['income', 'expense'].forEach(t => {
                const sum = currentData.filter(d => d.who === w && d.type === t).reduce((a,c)=>a+c.amount,0);
                document.getElementById(`total-${w}-${t}`).innerText = sum.toLocaleString() + 'ì›';
            }));

            document.getElementById('month-balance').innerText = (totalIncome - totalExpense).toLocaleString() + 'ì›';
        }

        window.renderSummary = function() {
            const tbody = document.getElementById('summary-body');
            tbody.innerHTML = '';

            const summary = {};
            ledgerData.forEach(item => {
                if(!summary[item.month]) summary[item.month] = { income: 0, expense: 0 };
                if(item.type === 'income') summary[item.month].income += item.amount;
                else summary[item.month].expense += item.amount;
            });

            const sortedMonths = Object.keys(summary).sort().reverse();
            let grandBalance = 0;

            sortedMonths.forEach(month => {
                const s = summary[month];
                const balance = s.income - s.expense;
                grandBalance += balance;

                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 border-b">
                        <td class="px-4 py-3 font-bold">${month}</td>
                        <td class="px-4 py-3 text-right text-blue-600 font-medium">+${s.income.toLocaleString()}</td>
                        <td class="px-4 py-3 text-right text-red-600 font-medium">-${s.expense.toLocaleString()}</td>
                        <td class="px-4 py-3 text-right font-bold ${balance >= 0 ? 'text-green-600' : 'text-red-600'}">
                            ${balance.toLocaleString()}
                        </td>
                    </tr>
                `;
            });
            document.getElementById('grand-total-balance').innerText = grandBalance.toLocaleString() + 'ì›';
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ (ì „ì—­ ìŠ¤ì½”í”„ ë…¸ì¶œ)
        window.updateForm = function() {
            const type = document.getElementById('in-type').value;
            const methodSelect = document.getElementById('in-method');
            const catSelect = document.getElementById('in-category');
            catSelect.innerHTML = ''; 

            if(type === 'income') {
                methodSelect.classList.add('hidden');
                CAT_INCOME.forEach(c => catSelect.innerHTML += `<option value="${c}">${c}</option>`);
            } else {
                methodSelect.classList.remove('hidden');
                CAT_EXPENSE.forEach(c => catSelect.innerHTML += `<option value="${c}">${c}</option>`);
            }
            window.updateHint();
        }

        window.updateHint = function() {
            const cat = document.getElementById('in-category').value;
            const desc = document.getElementById('in-desc');
            if(cat === 'ì›” ì¹´ë“œê°’') desc.placeholder = "ì˜ˆ: í˜„ëŒ€ì¹´ë“œ";
            else if(cat === 'ê³ ì •ë¹„') desc.placeholder = "ì˜ˆ: ì›”ì„¸, ì´ì";
            else desc.placeholder = "ë‚´ìš© ì…ë ¥";
        }

        window.switchTab = function(mode) {
            const btnWrite = document.querySelector('button[onclick="window.switchTab(\'write\')"]');
            const btnSummary = document.querySelector('button[onclick="window.switchTab(\'summary\')"]');

            if (mode === 'write') {
                document.getElementById('view-write').classList.remove('hidden-tab');
                document.getElementById('view-summary').classList.add('hidden-tab');
                btnWrite.classList.add('text-blue-600'); btnWrite.classList.remove('text-gray-400');
                btnSummary.classList.add('text-gray-400'); btnSummary.classList.remove('text-blue-600');
                renderDaily();
            } else {
                document.getElementById('view-write').classList.add('hidden-tab');
                document.getElementById('view-summary').classList.remove('hidden-tab');
                btnSummary.classList.add('text-blue-600'); btnSummary.classList.remove('text-gray-400');
                btnWrite.classList.add('text-gray-400'); btnWrite.classList.remove('text-blue-600');
                renderSummary();
            }
        }

        // ì´ˆê¸° ì‹¤í–‰
        updateForm();
        
        // ì›” ë³€ê²½ ì‹œ ë Œë”ë§ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        globalMonthEl.addEventListener('change', renderDaily);

        // ì—”í„°í‚¤ ì…ë ¥ ì´ë²¤íŠ¸
        document.getElementById('in-amount').addEventListener('keydown', (e) => {
            if(e.key === 'Enter') window.addData();
        });
        document.getElementById('btn-add').addEventListener('click', window.addData);

    </script>
</body>
</html>
