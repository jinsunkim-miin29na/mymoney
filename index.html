<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë¶€ë¶€ í†µí•© ìì‚°ê´€ë¦¬ v8.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Apple SD Gothic Neo', sans-serif; padding-bottom: 80px; background-color: #f3f4f6; }
        .excel-input { width: 100%; height: 100%; padding: 0 8px; border: none; outline: none; background: transparent; }
        .excel-input:focus { background-color: #eff6ff; }
        .mini-table th { font-size: 0.75rem; padding: 8px 4px; text-align: left; color: #6b7280; background: #f9fafb; }
        .mini-table td { font-size: 0.9rem; padding: 10px 4px; border-bottom: 1px solid #f3f4f6; }
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }
        .badge-card { background: #f3f4f6; color: #4b5563; border: 1px solid #d1d5db; }
        .badge-cash { background: #fff7ed; color: #c2410c; border: 1px solid #fed7aa; }
        .hidden-tab { display: none; }
        
        /* ìš”ì•½ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .summary-card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 16px; overflow: hidden; }
        .summary-header { padding: 12px 16px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .summary-row { display: flex; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid #f3f4f6; font-size: 0.95rem; }
        .summary-row:last-child { border-bottom: none; }
        .label-user { font-weight: bold; display: flex; align-items: center; gap: 6px; }
        .val-income { color: #2563eb; font-size: 0.85rem; }
        .val-expense { color: #dc2626; font-size: 0.85rem; }
        
        /* ê°•ì œ ìŠ¤íƒ€ì¼ (ë³´ë¼ìƒ‰ í—¤ë”) */
        .force-purple { background-color: #6b21a8 !important; color: white !important; }
    </style>
</head>
<body>

    <div id="view-write">
        <div class="bg-white sticky top-0 z-40 shadow-md border-b">
            <div class="flex justify-between items-center p-3 bg-gray-800 text-white">
                <h1 class="font-bold text-lg">ğŸ“ ì›”ë§ ì •ì‚°</h1>
                <input type="month" id="global-month" class="text-gray-900 font-bold px-2 py-1 rounded border-none outline-none">
            </div>
            
            <div class="flex flex-col md:flex-row bg-white">
                <div class="flex h-12 border-b md:border-b-0 md:border-r border-gray-200">
                    <select id="in-who" class="excel-input w-20 border-r text-center font-bold bg-gray-50 text-gray-700">
                        <option value="husband">ë‚¨í¸</option>
                        <option value="wife">ì•„ë‚´</option>
                    </select>
                    <select id="in-type" class="excel-input w-20 border-r text-center font-bold bg-gray-50 text-gray-700" onchange="window.updateForm()">
                        <option value="income">ìˆ˜ì…</option>
                        <option value="expense">ì§€ì¶œ</option>
                    </select>
                    <select id="in-method" class="hidden excel-input w-24 border-r text-center text-sm bg-white">
                        <option value="ì¹´ë“œ">ì¹´ë“œ</option>
                        <option value="í˜„ê¸ˆ">í˜„ê¸ˆ/ì´ì²´</option>
                    </select>
                </div>
                <div class="flex h-12 flex-1 items-center">
                    <select id="in-category" class="excel-input w-28 border-r text-sm font-bold text-gray-600" onchange="window.updateHint()">
                    </select>
                    <input type="text" id="in-desc" class="excel-input flex-1 min-w-[80px]" placeholder="ë‚´ìš©">
                    <input type="number" id="in-amount" class="excel-input w-24 text-right font-bold text-lg text-blue-900" placeholder="0">
                    <button id="btn-add" class="bg-blue-600 text-white w-16 h-full font-bold text-sm hover:bg-blue-700">ì…ë ¥</button>
                </div>
            </div>
        </div>

        <div class="max-w-6xl mx-auto p-3 mt-2">
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 flex justify-between items-center">
                <div>
                    <p class="text-xs text-gray-500 mb-1">ì´ë‹¬ì˜ í˜„ê¸ˆ ì”ì•¡</p>
                    <p class="text-2xl font-bold text-blue-600" id="month-balance">0ì›</p>
                </div>
                <div class="text-right">
                    <p class="text-xs text-red-400 mb-1">ë§ˆí†µ/ëŒ€ì¶œ ì”ì•¡</p>
                    <p class="text-xl font-bold text-red-600">-12,500,000ì›</p>
                </div>
            </div>
        </div>

        <div class="max-w-6xl mx-auto p-3 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="space-y-4">
                <h2 class="font-bold text-lg text-gray-800 flex items-center gap-2">ğŸ‘¨â€ğŸ’» ë‚¨í¸</h2>
                <div class="bg-white rounded shadow-sm border-t-4 border-blue-500">
                    <div class="px-3 py-2 bg-blue-50 flex justify-between"><span class="text-sm font-bold">ìˆ˜ì…</span><span id="total-husband-income" class="text-sm font-bold">0ì›</span></div>
                    <table class="w-full mini-table"><tbody id="list-husband-income"></tbody></table>
                </div>
                <div class="bg-white rounded shadow-sm border-t-4 border-red-500">
                    <div class="px-3 py-2 bg-red-50 flex justify-between"><span class="text-sm font-bold">ì§€ì¶œ</span><span id="total-husband-expense" class="text-sm font-bold">0ì›</span></div>
                    <table class="w-full mini-table"><tbody id="list-husband-expense"></tbody></table>
                </div>
            </div>
            <div class="space-y-4">
                <h2 class="font-bold text-lg text-gray-800 flex items-center gap-2">ğŸ‘©â€ğŸ’¼ ì•„ë‚´</h2>
                <div class="bg-white rounded shadow-sm border-t-4 border-indigo-500">
                    <div class="px-3 py-2 bg-indigo-50 flex justify-between"><span class="text-sm font-bold">ìˆ˜ì…</span><span id="total-wife-income" class="text-sm font-bold">0ì›</span></div>
                    <table class="w-full mini-table"><tbody id="list-wife-income"></tbody></table>
                </div>
                <div class="bg-white rounded shadow-sm border-t-4 border-pink-500">
                    <div class="px-3 py-2 bg-pink-50 flex justify-between"><span class="text-sm font-bold">ì§€ì¶œ</span><span id="total-wife-expense" class="text-sm font-bold">0ì›</span></div>
                    <table class="w-full mini-table"><tbody id="list-wife-expense"></tbody></table>
                </div>
            </div>
        </div>
    </div>

    <div id="view-summary" class="hidden-tab">
        <div class="sticky top-0 z-40 shadow-md p-4 flex justify-between items-center force-purple">
            <h1 class="font-bold text-lg">ğŸ“Š ì›”ë³„/ì¸ë¬¼ë³„ ìš”ì•½</h1>
            <div class="text-xs text-purple-200">v8.0 (ìµœì‹ )</div>
        </div>

        <div class="max-w-4xl mx-auto p-4" id="summary-container">
            </div>

        <div class="p-4 text-center">
            <div class="bg-indigo-100 p-4 rounded-xl inline-block w-full max-w-sm">
                <p class="text-gray-500 text-xs mb-1">ìš°ë¦¬ ì§‘ ì´ ëˆ„ì  ìì‚°(í˜„ê¸ˆ)</p>
                <p class="text-2xl font-bold text-indigo-700" id="grand-total-balance">0ì›</p>
            </div>
        </div>
    </div>

    <nav class="fixed bottom-0 w-full bg-white border-t border-gray-300 flex justify-around items-center h-16 z-50 shadow-lg">
        <button onclick="window.switchTab('write')" class="flex flex-col items-center w-full h-full justify-center active-tab text-blue-600" id="nav-write">
            <span class="text-2xl">ğŸ“</span>
            <span class="text-xs font-bold mt-1">ì‘ì„±í•˜ê¸°</span>
        </button>
        <div class="w-px h-8 bg-gray-200"></div>
        <button onclick="window.switchTab('summary')" class="flex flex-col items-center w-full h-full justify-center text-gray-400" id="nav-summary">
            <span class="text-2xl">ğŸ“Š</span>
            <span class="text-xs font-bold mt-1">ì „ì²´ë³´ê¸°</span>
        </button>
    </nav>

    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyBAGmA7oUu5xZcqiEn_JIZ21CO0n6bRFUM",
            authDomain: "mymoney-ledger.firebaseapp.com",
            projectId: "mymoney-ledger",
            storageBucket: "mymoney-ledger.firebasestorage.app",
            messagingSenderId: "536040673268",
            appId: "1:536040673268:web:5cc54395dd33fbb99bb3a1"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let ledgerData = [];
        const globalMonthEl = document.getElementById('global-month');
        const today = new Date();
        globalMonthEl.value = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;

        const CAT_INCOME = ["ì›”ê¸‰", "ê³„ì•½ê¸ˆ", "ì •ë¶€ì§€ì›ê¸ˆ", "ê²½ì¡°ì‚¬ë¹„", "ê¸°íƒ€ìˆ˜ì…"];
        const CAT_EXPENSE = ["ì›” ì¹´ë“œê°’", "ê³ ì •ë¹„", "ìƒí™œë¹„", "ê¸°íƒ€ì§€ì¶œ"];

        // -----------------------------------------------------------
        // 1. í•µì‹¬ í•¨ìˆ˜ë“¤ì„ ë¨¼ì € constë¡œ ì •ì˜ (ìŠ¤ì½”í”„ ë¬¸ì œ í•´ê²°)
        // -----------------------------------------------------------

        const renderDaily = () => {
            const targetMonth = globalMonthEl.value;
            const currentData = ledgerData.filter(d => d.month === targetMonth);
            
            ['husband', 'wife'].forEach(w => ['income', 'expense'].forEach(t => {
                document.getElementById(`list-${w}-${t}`).innerHTML = '';
                document.getElementById(`total-${w}-${t}`).innerText = '0ì›';
            }));

            let totalIncome = 0, totalExpense = 0;

            currentData.forEach(item => {
                const tbody = document.getElementById(`list-${item.who}-${item.type}`);
                if (!tbody) return; // ì•ˆì „ì¥ì¹˜

                let badge = "";
                if(item.type === 'expense') {
                    const bClass = item.method === 'ì¹´ë“œ' ? 'badge-card' : 'badge-cash';
                    badge = `<span class="badge ${bClass} mr-1">${item.method}</span>`;
                }
                
                tbody.innerHTML += `
                    <tr>
                        <td>
                            <div class="text-xs text-gray-500">[${item.cat}]</div>
                            <div class="font-bold text-gray-700">${badge}${item.desc}</div>
                        </td>
                        <td class="text-right font-bold ${item.type==='income'?'text-blue-600':'text-red-600'}">
                            ${item.amount.toLocaleString()}
                        </td>
                        <td class="w-8 text-center"><button onclick="window.removeData('${item.dbId}')" class="text-gray-300 hover:text-red-500">Ã—</button></td>
                    </tr>
                `;
                if(item.type === 'income') totalIncome += item.amount;
                else totalExpense += item.amount;
            });

            ['husband', 'wife'].forEach(w => ['income', 'expense'].forEach(t => {
                const sum = currentData.filter(d => d.who === w && d.type === t).reduce((a,c)=>a+c.amount,0);
                document.getElementById(`total-${w}-${t}`).innerText = sum.toLocaleString() + 'ì›';
            }));

            document.getElementById('month-balance').innerText = (totalIncome - totalExpense).toLocaleString() + 'ì›';
        }

        const renderSummary = () => {
            try {
                const container = document.getElementById('summary-container');
                container.innerHTML = '';

                const summary = {};
                ledgerData.forEach(item => {
                    // ë°ì´í„° ê²€ì¦
                    if(!item.who || !item.month || !item.type) return;

                    if(!summary[item.month]) {
                        summary[item.month] = { 
                            husband: { income: 0, expense: 0 },
                            wife: { income: 0, expense: 0 }
                        };
                    }
                    if(summary[item.month][item.who]) {
                        if(item.type === 'income') summary[item.month][item.who].income += (item.amount || 0);
                        else summary[item.month][item.who].expense += (item.amount || 0);
                    }
                });

                const sortedMonths = Object.keys(summary).sort().reverse();
                let grandBalance = 0;

                sortedMonths.forEach(month => {
                    const s = summary[month];
                    const husBal = s.husband.income - s.husband.expense;
                    const wifeBal = s.wife.income - s.wife.expense;
                    const monthTotal = husBal + wifeBal;
                    grandBalance += monthTotal;

                    const cardHTML = `
                        <div class="summary-card">
                            <div class="summary-header force-purple">
                                <span>ğŸ“… ${month}</span>
                                <span class="${monthTotal >= 0 ? 'text-green-300' : 'text-red-300'} text-sm">
                                    í•©ê³„ ${monthTotal > 0 ? '+' : ''}${monthTotal.toLocaleString()}
                                </span>
                            </div>
                            
                            <div class="summary-row">
                                <div class="label-user text-blue-800">ğŸ‘¨â€ğŸ’» ë‚¨í¸</div>
                                <div>
                                    <span class="val-income text-xs">ìˆ˜ì… ${s.husband.income.toLocaleString()}</span> /
